// Add any tips or answers to anticipated questions.

== FAQ

*Q.* I encountered a *CREATE_FAILED* error when I launched the Quick Start.

*A.* If AWS CloudFormation fails to create the stack, relaunch the template with *Rollback on failure* set to *Disabled*. This setting is under *Advanced* in the AWS CloudFormation console on the *Configure stack options* page. With this setting, the stack’s state is retained, and the instance keeps running so that you can troubleshoot the issue. (For Windows, look at the log files in `%ProgramFiles%\Amazon\EC2ConfigService` and `C:\cfn\log`.)
// Customize this answer if needed. For example, if you’re deploying on Linux instances, either provide the location for log files on Linux or omit the final sentence. If the Quick Start has no EC2 instances, revise accordingly (something like "and the assets keep running").

WARNING: When you set *Rollback on failure* to *Disabled*, you continue to incur AWS charges for this stack. Delete the stack when you finish troubleshooting.

For more information, see https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/troubleshooting.html[Troubleshooting AWS CloudFormation^].

*Q.* I encountered a size-limitation error when I deployed the AWS CloudFormation templates.

*A.* Launch the Quick Start templates from the links in this guide or from another S3 bucket. If you deploy the templates from a local copy on your computer or from a location other than an S3 bucket, you might encounter template-size limitations. For more information, see http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cloudformation-limits.html[AWS CloudFormation quotas^].


== Troubleshooting

=== CloudFormation nested stack deployment

During deployment, you can monitor the progress of the stack by choosing **Events** on the top-level stack. Below is a description of each nested stack’s function in the order in which they are deployed.

==== AWSVPCSTACK Nested Stack

If deploying in a new VPC, this is the first nested stack that will appear in the CloudFormation console events view.
This stack creates the VPC, private subnet, public subnet, route tables, NAT gateway, Internet gateway, and a Gateway 
VPC Endpoint for S3.  It also creates public and private subnets in a second Availability Zone for a future DR cluster.  
See the section later in this guide *Adding a DR Cluster*.

==== CloudQStack Nested Stack

All subsequent nested stacks will be contained within the CloudQStack.  If deploying in an existing
VPC this will be the first stack that will appear in the CloudFormation console events view. All nested 
stacks prior to the QSTACK execute in paralllel.  All stacks after the QSTACK execute in parallel.

===== QLOOKUPSTACK Nested Stack

The QLOOKUP Stack is a hierarchical region map that finds the AMI-ID for the marketplace offer 
by region. Note, this stack is not executed when selecting the Specified-AMI-ID option.

===== SECRETSSTACK Nested Stack

The SECRETS Stack stores usernames and passwords in Secrets Manager for the cluster, sidecar, 
and downloading software from Qumulo Trends. The purpose of leveraging Secrets Manager is to 
provide a secure reference for subsequent stacks and users who may forget the passwords assigned.

===== QIAMSTACK Nested Stack

The QIAM Stack creates an IAM profile for the Qumulo Cluster to enable the cluster to manage
EC2 Secondary IP addresses (Floating IPs), decrypt data, send CloudWatch alarms, and send
audit logs to CloudWatch Logs. Note, creating IAM roles with CloudFormation takes some time so don’t be
alarmed if the QIAM stack takes 3 or 4 minutes.

===== QSTACK Nested Stack

The Q Stack spins up all the EC2 instances and EBS volumes for the cluster. It also creates a
placement group for the cluster and tags all the EC2 instances with the appropriate stack
name and node number. In addition, it creates CloudWatch alarms for EC2 instance failure and
a security group for the cluster with the CIDR specified in the template.

===== QADDCIDRSTACK Nested Stack

If additional CIDRs for the Qumulo Security Group were populated, then this nested stack will execute.  
It simply adds the additional CIDRs for ingress traffic respective of all the ports in the security group.

===== MGMTNLBSTACK Nested Stack

If public management of the cluster was chosen in the template this nested stack is executed as 
long as the cluster is NOT being deployed in an AWS Local Zone. It spins up a Network Load Balancer 
with a public Elastic IP. The load balancer listens only on port 443 and optionally on port 3712 if 
the replication port was selected. This load balancer connects to the primary EC2 IP address on each node. 
These are known as the persistent IPs in the Qumulo UI.

===== DNSSTACK Nested Stack

If the Route 53 Private Hosted Zone FQDN was configured then the DNS stack is executed. It
creates the private hosted zone and all the A-records with the name assigned in the template.
All records are given a TTL=0. While round-robin behavior is the goal, Route 53 doesn’t
provide perfect round-robin. Instead the records are given an equal probability of resolution.
Clients are well distributed, but not perfectly symmetric.

===== PROVISIONINGSTACK Nested Stack

This stack spins up an EC2 instance with custom user data. It configures the Qumulo Cluster
and additional AWS environment requirements.  The lists below highlight the major tasks of the
provisioning instance.

====== Qumulo Configuration
* Software upgrades of QSTACK created nodes
* Forms the first quorum for the cluster
* Assigns Floating IP addresses to the cluster
* Configures Sidecar username, password, and custom RBAC role
* Configures Audit Logging for CloudWatch Logs
* Changes the admin password

====== AWS Configuration
* Checks for Public Internet reachability with a CURL test to trends.qumulo.com
* Assigns a QSTACK Policy to protect the cluster in subsequent Stack Updates
* Edits the Customer Managed Key Policy so Sidecar can create CMK encrypted volumes
* Tags EBS volumes with the stack name and volume type
* Tracks software versions, cluster IPs, instance IDs, & UUID in AWS Parameter Store
* Tracks the provisioning instance ‘last-run-status’ in Parameter Store
* Configures Termination Protection for the Stack and the EC2 Instances

This instance automatically shuts down upon completion of its provisioning tasks. **Do not delete this EC2 instance. It will be used for stack updates.**

===== CLOUDWATCHSTACK Nested Stack

This stack creates resource groups, a CloudWatch dashboard, and a CloudWatch log group
(optional) for the cluster. First, it creates a resource group for the EC2 instances and then it
creates one or more resource groups for the EBS volumes. The resource groups created for the
EBS volumes depend on the EBS volume configuration of the cluster. All Flash clusters will
have just one resource group with the stack name and -SSD. Hybrid clusters will have two
resource groups for EBS: one with -SSD and one with -HDD. The purpose of these resource
groups is to provide a simple means to create a filtered view in CloudWatch for the EC2 and
EBS metrics native to AWS.

A CloudWatch Dashboard is also created that presents key metrics sent by the Sidecar Metrics
Lambda function. These are Qumulo specific metrics.
Finally, if Audit Logging was enabled a CloudWatch log group is created for the cluster. All
administrative activity, Lambda access, and file/directory create/modify/delete activity is captured
in this log.

===== QSIDECARSTACK Nested Stack

Assuming the provisioning option was left as YES, the SIDECAR stack is deployed. It creates
two Lambda functions with the specified Sidecar software version. The first is the Metrics
Lambda that sends Qumulo metrics to CloudWatch. The second is the Disk Recovery Lambda
that monitors EBS volumes and automatically replaces any failed EBS volumes. IAM roles,
permissions, and events are created for each Lambda function.

Below is the event view for the top-level stack followed by the event view for the CloudQStack. Note the timestamps to manage expectations on the duration for each nested stack.

[#additional0]
.CloudFormation top-level stack events
image::../images/image0.png[Additional0,width=50%,height=50%]

[#additional1]
.CloudFormation CloudQStack events
image::../images/image1.png[Additional1]

=== Where’s the UUID for the cluster?

The Provisioning instance grabs a copy of the UUID for the cluster after the first quorum is
formed. Go to **Parameter Store** and filter on the top-level stack name. The following
parameters are stored by the Provisioning instance. The UUID is last on the list. Select it to
view the UUID.

[#additional35]
.Parameters
image::../images/image35.png[Additional35]

=== Forgot the cluster admin password

The admin password entered when the cluster was originally provisioned is stored in AWS Secrets Manager.  Go to *Secrets Manager* and filter on the top-level stack name.  Then look for *ClusterSecrets* and then *Retrieve secret value*.   Also, if the admin password is changed post-deployment, it must be updated in Secrets Manager for stack updates to function correctly.

=== The Stack failed on the nested stack AWSVPCSTACK or CloudQStack

The S3 Bucket, Key Name Prefix, or Object URL are not correct when deploying from your own S3 bucket. Delete the stack and relaunch
the template with the correct S3 parameters. Do NOT use the S3 URL, use the Object URL for
the template or the stack will fail.  If deploying from the AWS Quick Start bucket do not change the bucket name, prefix, or region for the bucket.

=== The Stack failed when provisioning the QSTACK

The four most common causes for this are:

1. An AWS Marketplace offer has not been accepted that matches the **Qumulo AWS Marketplace Offering Accepted** parameter entered in the template
2. The EBS volumes configuration doesn’t match the requirements for the **Qumulo AMI ID** entered when using the Specified-AMI-ID option
3. The cluster failed to place in the placement group
4. Service Quotas were not pre-planned and the QSTACK failed. 

Review the AMI ID and marketplace subscriptions. Double check the EBS volume config selected in the template. If the cluster failed to place, choose a different AZ to deploy the cluster in to find more available resources by selecting a different private subnet ID within the VPC. Adjust Service Quotas if necessary. Delete the failed stack and relaunch the template after rectifying the problem.

=== The Stack Update failed and rolled back

No harm is done. No Qumulo Cluster parameters for the QSTACK, except the Number of EC2 Instances, can be changed. The number of instances can’t be decreased.

=== The Cluster didn’t form quorum

If the quorum has not been formed the UI will appear as below.  DO NOT form quorum manually because the provisioning instance will not
be able to complete secondary provisioning of the cluster and AWS infrastructure.

[#additional36]
.UI for a Cluster that hasn't formed quorum
image::../images/image36.png[Additional36]

The four most common causes for this are:

1. The software version specified in the template doesn’t exist
2. The software version specified in the template is older than the AMI software version
3. The VPC doesn't have public internet access
4. The VPC doesn’t have public internet access and the upgrade image(s) were not placed in the /upgrade folder in the S3 bucket, see see **The Provisioning instance didn’t shut down**

Check for typos by reviewing the parameters entered in the template in the CloudFormation
console. Double check the software version specified for the cluster and make sure it is equal
to or newer than the version the Marketplace offer lists. Rectify and restart the Provisioning instance or delete the stack and redeploy.

=== The Provisioning instance didn’t shut down

In most use cases the provisioning instance will shutdown in 5 minutes or less after the stack has completed deployment.  If the Provisioning instance hasn't shutdown after 15 minutes there's likely an issue.  Each software upgrade takes ~4 minutes.  The instances are upgraded in parallel so instance count has a minimal impact on execution time.  If you have an AMI ID with an older software verison it may have to do multiple upgrades to get the cluster on the desired version.  See the *AWS Parameter Store last-run-status* section below.

==== Common Causes

The four most common causes for this are:

1. The VPC doesn’t have access to the public Internet or DNS resolution is not functioning.  Without access to public infrastructure the Provisioning instance can’t talk to AWS services like Secrets Manager, KMS, Parameter Store, or download the desired version of Qumulo Core software.  Review the public and private subnets, their route tables, and the NAT Gateway.  Review the AWS Parameter Store *last-run-status* to verify public internet connectivity (see the section below on last-run-status). Also double check that there are no Network ACLs blocking traffic.
2. The VPC doesn’t have access to the public Internet, but this was planned.  One or more VPC Endpoints may be missing.  The VPC Interface Endpoints Security Group is not correct.  The desired Qumulo Core software version has not been placed in the S3 Bucket /upgrade folder.  See the section *Deploying without Internet Access*.
3. A Customer Managed Key was provisioned and the policy was unable to be modified for the CMK because the policy didn’t have valid SIDs before the template was launched.
4. A stack update was executed to add nodes.  The stack update succeeded but the provisioning instance didn’t shutdown and the nodes were not added to the cluster.  Most likely the Cluster’s admin password was changed post deployment.  If this is the case go to *Secrets Manager*, filter on the top-level stack name, and look for *ClusterSecrets*.  *Retrieve secret value* and *Edit*.  Update the admin password and save the secret.  Then stop and restart the provisioning instance.

Cleanup the CMK, correct the VPC infrastructure, update the admin password and restart the provisioning instance.  See the sections that follow on restarting the provisioning instance, monitoring its status in the Parameter Store, and downloading logs.

==== AWS Parameter Store last-run-status

If the Provisioning instance doesn’t automatically shutdown, the AWS Systems Manager Parameter Store *last-run-status* parameter may be checked to see where it stopped.  As shown below, the parameter history shows the major blocks in the code the provisioning instance executes.  In this example QCluster1 was built for the first time as noted by the *Forming first quorum and configuring cluster* update to the last-run-status parameter.  Note that two software upgrades were also performed per the Qumulo quarterly cadence to reach the 4.2.0 software release.


[#additional37]
.Parameter Store history
image::../images/image37.png[Additional37]

==== Restarting the Provisioning Instance

The Provisioning instance is designed to restart with every Stack Update.  Further, it may be manually stopped from the AWS Console, if it doesn’t automatically stop, and then manually restarted.  Examples where this may be very helpful are if software wasn’t placed in the S3 bucket when deploying without internet access, a CMK policy wasn’t cleaned up prior to deployment, or intended internet connectivity wasn’t functioning as expected and has been rectified.

==== Download the Provisioning instance log

In the event none of the troubleshooting steps help to rectify the problems it’s likely the
Provisioning instance log will be helpful. To retrieve the log follow these steps:

1. Go to the AWS Console **EC2 Instances** page
2. **Check the box** beside the Provisioning instance
3. Select **Actions** in the upper right corner
4. Select **Monitor & troubleshoot**
5. Select **Get system log**
6. Select Download in the upper right corner

Feel free to review the log right in the AWS console or download it to collaborate with Qumulo
to resolve the problem. Often the log will show an obvious error pointing you to the
resolution.

==== Provisioning instance flow chart

The provisioning instance executes the code in user data every boot cycle. The abbreviated
logic diagram below shows the major branches and AWS SSM Parameter Store values for
**last-run-status** throughout the execution of the code.

[#additional38]
.Provisioning instance flow chart
image::../images/image38.png[Additional38]
