AWSTemplateFormatVersion: "2010-09-09"

# MIT License
#
# Copyright (c) 2021 Qumulo, Inc.
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal 
# in the Software without restriction, including without limitation the rights 
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell 
# copies of the Software, and to permit persons to whom the Software is 
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all 
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR 
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, 
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE 
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER 
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, 
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE 
# SOFTWARE.

Description: This is the main template to spin up a standard Qumulo cluster with all options available in an existing VPC. It calls cloudq.cft.yaml to instantiate the infrastructure. (qs-1s6n2i6af)

Metadata:
  cfn-lint:
    config:
      ignore_checks:
        - W9006
        - W9901
        - E9902 #Unknown exception while processing rule E9902
        - E9903 #Unknown exception while processing rule E9903
        - E9904 #Unknown exception while processing rule E9904
  QuickStartDocumentation:
    EntrypointName: 'Parameters for deploying into an existing VPC with advanced parameters'
    Order: '2'
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: AWS Template Configuration - Cloud Q Quick Start Existing VPC - Advanced v3.7
        Parameters:
          - QSS3BucketName
          - QSS3KeyPrefix
          - QSS3BucketRegion
          - KeyPair
          - EnvType

      - Label: 
          default: AWS Network Configuration
        Parameters:
          - VPCId
          - QSgCidr1
          - QSgCidr2
          - QSgCidr3
          - QSgCidr4                              
          - PrivateSubnetID
          - QClusterLocalZone
          - SideCarPrivateSubnetID
          - QPublicMgmt
          - QPublicRepl
          - PublicSubnetID
          - DomainName
          - QFloatRecordName

      - Label:
          default: Qumulo File Data Platform Configuration
        Parameters:
          - QDr
          - QMarketPlaceType
          - QAmiID
          - QInstanceType
          - QNodeCount
          - QDiskConfig
          - QFloatingIP
          - QClusterVersion
          - QClusterName
          - QClusterAdminPwd
          - VolumesEncryptionKey
          - QPermissionsBoundary
          - QInstanceRecoveryTopic
          - QAuditLog
          - TermProtection

      - Label:
          default: Qumulo EBS Monitoring/Replacement & CloudWatch Metrics Configuration
        Parameters:
          - SideCarProv
          - SideCarVersion
          - SideCarSNSTopic

    ParameterLabels:
      QSS3BucketName:
        default: "S3 Bucket Name"
      QSS3KeyPrefix:
        default: "S3 Key Prefix Name (Path in the bucket inclusive of quickstart-qumulo-cloud-q folder)"
      QSS3BucketRegion:
        default: "S3 Bucket Region"
      KeyPair:
        default: "AWS Key-Pair Name"
      EnvType:
        default: "OPTIONAL: Environment Type"
      VPCId:
        default: "AWS VPC ID"
      PrivateSubnetID:
        default: "AWS Private Subnet ID"
      PublicSubnetID:
        default: "AWS Public Subnet ID"
      QSgCidr1:
        default: "Qumulo Security Group CIDR #1 "
      QSgCidr2:
        default: "OPTIONAL: Qumulo Security Group CIDR #2 "
      QSgCidr3:
        default: "OPTIONAL: Qumulo Security Group CIDR #3 "
      QSgCidr4:
        default: "OPTIONAL: Qumulo Security Group CIDR #4 "                        
      QPublicMgmt: 
        default: "OPTIONAL: Provision Public IP for Qumulo Management"
      QPublicRepl: 
        default: "OPTIONAL: Enable Replication Port for Qumulo Public IP"        
      DomainName:
        default: "OPTIONAL: FQDN for R53 Private Hosted Zone"
      QFloatingIP:
        default: "Floating IP for IP Failover"
      QFloatRecordName:
        default: "OPTIONAL: R53 Record Name for Qumulo RR DNS "
      QDr:
        default: "Is the Qumulo Cluster being deployed for Disaster Recovery?"
      QClusterName:
        default: "Qumulo Cluster Name"
      QClusterAdminPwd:
        default: "Qumulo Cluster Admin Password"
      QNodeCount: 
        default: "Total Number of Qumulo EC2 Instances"
      QDiskConfig:
        default: "EBS Volume Configuration per EC2 Instance"
      QClusterVersion:
        default: "Qumulo Core Software Version"
      QAmiID:
        default: "Qumulo AWS AMI ID"
      QMarketPlaceType:
        default: "Qumulo AWS Marketplace Offering Accepted"
      QInstanceType:
        default: "Qumulo EC2 Instance Type"
      VolumesEncryptionKey:
        default: "OPTIONAL: AWS EBS Volumes Encryption Key "
      QPermissionsBoundary:
        default: "OPTIONAL: AWS Permissions Boundary Policy Name"
      QInstanceRecoveryTopic:
        default: "OPTIONAL: Qumulo EC2 Instance Recovery Topic"
      QAuditLog:
        default: "OPTIONAL: Send Qumulo Audit Log messages to CloudWatch Logs? "
      TermProtection:
        default: "Enable Termination Protection "
      QClusterLocalZone:
        default: "Is the Qumulo Cluster being deployed in a Local Zone or Outpost?"
      SideCarProv:
        default: "Provision Qumulo Sidecar Lambdas"
      SideCarPrivateSubnetID:
        default: "Qumulo Sidecar Lambdas Private Subnet ID"
      SideCarVersion:
        default: "Qumulo Sidecar Software Version "
      SideCarSNSTopic:
        default: "OPTIONAL: Qumulo EBS Volume Recovery SNS Topic "

Parameters:

  QSS3BucketName:
    AllowedPattern: '^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$'
    ConstraintDescription:
      The Quick Start bucket name can include numbers, lowercase
      letters, uppercase letters, and hyphens (-). It cannot start or end with a 
      hyphen (-).
    Default: aws-quickstart
    Description:
      'Name of the S3 bucket for your copy of the Quick Start assets. 
      Keep the default name unless you are customizing the template. 
      Changing the name updates code references to point to a new Quick 
      Start location. This name can include numbers, lowercase letters, 
      uppercase letters, and hyphens, but do not start or end with a hyphen (-). 
      See https://aws-quickstart.github.io/option1.html.'
    Type: String

  QSS3BucketRegion:
    Default: us-east-1
    Description: 'AWS Region where the Quick Start S3 bucket (QSS3BucketName) is 
    hosted. Keep the default Region unless you are customizing the template. 
    Changing this Region updates code references to point to a new Quick Start location. 
    When using your own bucket, specify the Region. 
    See https://aws-quickstart.github.io/option1.html.'
    Type: String

  QSS3KeyPrefix:
    AllowedPattern: '^[0-9a-zA-Z-/]*$'
    ConstraintDescription:
      The Quick Start S3 key prefix can include numbers, lowercase letters,
      uppercase letters, hyphens (-), and forward slashes (/).
    Default: quickstart-qumulo-cloud-q/
    Description:
      'S3 key prefix that is used to simulate a directory for your copy of the 
      Quick Start assets. Keep the default prefix unless you are customizing 
      the template. Changing this prefix updates code references to point to 
      a new Quick Start location. This prefix can include numbers, lowercase 
      letters, uppercase letters, hyphens (-), and forward slashes (/). 
      See https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingMetadata.html 
      and https://aws-quickstart.github.io/option1.html.'
    Type: String

  KeyPair:
    Description: Name of an existing EC2 Key Pair to enable authentication to instances
    Type: AWS::EC2::KeyPair::KeyName
    Default: mykeypair

  EnvType:
    Description: "Type of Environment: Dev, QA, or, Prod"
    AllowedValues:
      - dev
      - qa
      - prod
    Type: String
    Default: dev

  VPCId:
    Type: AWS::EC2::VPC::Id
    Description: AWS VPC ID.

  QPublicMgmt:
    AllowedValues:
      - "YES"
      - "NO"
    Description: Select YES to provision an Elastic IP Address (public static) attached to a Network Loadbalancer listening only on port 443 for Qumulo Managment.  Not supported in Local Zones or Outpost.
    Type: String
    Default: "NO"

  QPublicRepl:
    AllowedValues:
      - "YES"
      - "NO"
    Description: Select YES to enable port 3712 for replication from on-prem Qumulo systems using the Elastic IP (public static) for Qumulo Managment.  Requires YES to Public Management above.
    Type: String
    Default: "NO"

  PublicSubnetID:
    Type: AWS::EC2::Subnet::Id
    Description: An AWS subnet ID MUST be selected. It is only used if YES for Public Management was selected above.

  PrivateSubnetID:
    Type: AWS::EC2::Subnet::Id
    Description: AWS Private Subnet in the VPC.

  DomainName:
    Description: "(Optional) Enter a fully qualified domain name to create a private Route 53 private hosted zone to resolve IP addresses. You may use the .local suffix, e.g. qumulo.companyname.local. If your VPC already has a means of DNS resolution and you do not need to create a Route 53 private hosted zone, keep this value blank."
    AllowedPattern: '^$|^([a-zA-Z0-9-]+\..+)$'
    MaxLength: '255'
    Type: String
    Default: ""

  QDr:
    AllowedValues:
      - "YES"
      - "NO"
    Description: Select YES if the cluster is being deployed for a Disaster Recovery workload.
    Type: String
    Default: "NO"

  QFloatRecordName:
    Description: "ONLY APPLICABLE if a domain name was provided above.  Record Name for R53 Private Hosted Zone Qumulo Cluster floating IPs.  This will add a prefix to the example FQDN above: e.g. cluster1.qumulo.mycompanyname.local"
    Type: String
    Default: ""

  QNodeCount:
    Description: "Total number of EC2 instances, or Qumulo Nodes, in the Qumulo Cluster: (4-10).  NOTE: This field may be used to add nodes with a CloudFormation Stack Update after initial provisioning."
    AllowedValues:
      - Select for Custom Offering OR Expanding Cluster
      - "4"
      - "5"
      - "6"
      - "7"
      - "8"
      - "9"
      - "10"
      - "11"
      - "12"
      - "13"
      - "14"
      - "15"
      - "16"
      - "17"
      - "18"
      - "19"
      - "20"            
    Type: String
    Default: Select for Custom Offering OR Expanding Cluster

  QDiskConfig:
    Description: "Choose the EBS Volume configuration and type for the Qumulo EC2 instances: AF= SSD, Hybrid st1= SSD+HDD st1, Hybrid sc1= SSD+HDD sc1. NOTE: This must match the EBS capacity and type of the Customizable Private Offer."
    AllowedValues:
      - Select for Custom Offering
      - 600GiB-AF
      - 1TB-AF
      - 5TB-AF
      - 8TiB-AF
      - 13TiB-AF
      - 20TiB-AF
      - 30TB-AF
      - 35TiB-AF
      - 55TiB-AF
      - 5TB-Hybrid-st1
      - 8TiB-Hybrid-st1
      - 13TiB-Hybrid-st1
      - 20TB-Hybrid-st1
      - 35TiB-Hybrid-st1
      - 55TiB-Hybrid-st1
      - 90TiB-Hybrid-st1
      - 160TiB-Hybrid-st1
      - 256TiB-Hybrid-st1
      - 320TiB-Hybrid-st1
      - 8TiB-Hybrid-sc1
      - 13TiB-Hybrid-sc1
      - 20TB-Hybrid-sc1
      - 35TiB-Hybrid-sc1
      - 55TiB-Hybrid-sc1
      - 90TiB-Hybrid-sc1
      - 160TiB-Hybrid-sc1
      - 256TiB-Hybrid-sc1
      - 320TiB-Hybrid-sc1
    Type: String
    Default: Select for Custom Offering

  QAmiID:
    Description: "Only used for the Specified AMI-ID option above.  Amazon Machine Image ID supplied by Qumulo."
    Type: String
    Default: "Only for Specified AMI-ID Offering"

  QMarketPlaceType:
    Description: Select the Qumulo Cluster usable capacity per the accpeted AWS Marketplace offering.  Customizable offerings typically leverage a Private Offer via AWS Marketplace and can be used to deploy 1TB to 6PB with this template.
    AllowedValues:
      - 1TB-Usable-All-Flash
      - 12TB-Usable-Hybrid-st1
      - 96TB-Usable-Hybrid-st1
      - 103TB-Usable-All-Flash
      - 270TB-Usable-Hybrid-st1
      - 809TB-Usable-Hybrid-st1
      - Custom-1TB-6PB
      - Specified-AMI-ID
    Type: String
    Default: 1TB-Usable-All-Flash

  QFloatingIP:
    AllowedValues:
      - "1"
      - "2"
      - "3"
      - "4"
    Description: Number of EC2 Secondary IPs to be configured for each instance in the cluster, 1-4.
    Type: String
    Default: "3"

  QClusterName:
    AllowedPattern: "^[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9]$"
    Description: Name must be an alpha-numeric string between 2 and 15 characters. Dash (-) is allowed if not the first or last character.
    MaxLength: 15
    MinLength: 2
    Type: String
    Default: Cloud-Q

  QClusterVersion:
    Description: "Software version to install on the cluster.  NOTE: This field CAN NOT be used to upgrade the cluster with a CloudFormation Stack Update.
                 All Updates after initial creation must follow the quarterly release cadence using the Web UI or REST API."
    MaxLength: 11
    MinLength: 5
    Type: String
    Default: "4.2.5"

  QClusterAdminPwd:
    AllowedPattern: "^(?=.*[a-z])(?=.*[A-Z])(?=.*[@$!%*?&\\-_])[A-Za-z\\d@$!%*?&\\-_]{8,}$"
    Description: "Minumum 8 characters and must include one each of: uppercase, lowercase, and a special character."
    MaxLength: 128
    MinLength: 8
    Type: String
    NoEcho: "true"

  QInstanceType:
    Description: EC2 instance type for Qumulo nodes.
    AllowedValues:
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5.8xlarge
      - m5.12xlarge
      - m5.16xlarge
      - m5.24xlarge
      - c5n.4xlarge
      - c5n.9xlarge
      - c5n.18xlarge
    Type: String
    Default: m5.2xlarge

  VolumesEncryptionKey: 
    Description: "Leave Blank and AWS will generate a key. To specify a Customer Managed Key provide the KMS CMK ID: 12345678-1234-1234-1234-1234567890ab"
    Type: String
    Default: ""

  QPermissionsBoundary:
    Description: "Apply an IAM Permissions Boundary Policy to the Qumulo IAM roles that are created for the Qumulo cluster and provisioning instance.  This is an account based policy and is optional.  
                  Qumulo's IAM roles conform to the least privilege model."
    Type: String
    Default: ""

  QInstanceRecoveryTopic:
    Description: Optionally enter the ARN of an SNS topic that receives messages when an instance alarm is triggered.
    Type: String
    Default: ""

  QSgCidr1:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(3[0-2]|[1-2][0-9]|[0-9]))$"
    Description: An IPv4 CIDR block for specifying the generated security group's allowed addresses for inbound traffic. Typically set to the VPC CIDR.
    Type: String
    Default: "10.0.0.0/16"

  QSgCidr2:
    AllowedPattern: "^$|^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(3[0-2]|[1-2][0-9]|[0-9]))$"
    Description: An IPv4 CIDR block for specifying the generated security group's allowed addresses for inbound traffic.
    Type: String
    Default: ""

  QSgCidr3:
    AllowedPattern: "^$|^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(3[0-2]|[1-2][0-9]|[0-9]))$"
    Description: An IPv4 CIDR block for specifying the generated security group's allowed addresses for inbound traffic.
    Type: String
    Default: ""

  QSgCidr4:
    AllowedPattern: "^$|^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(3[0-2]|[1-2][0-9]|[0-9]))$"
    Description: An IPv4 CIDR block for specifying the generated security group's allowed addresses for inbound traffic.
    Type: String
    Default: ""

  TermProtection:
    Description: Enable Termination Protection for EC2 instances and the CloudFormation stack
    AllowedValues:
      - "YES"
      - "NO"
    Type: String
    Default: "YES"

  QClusterLocalZone:
    Description: AWS Lambda services are not supported in Local Zones or Outposts and will be placed in the subnet specified below.
    AllowedValues:
      - "YES"
      - "NO"
    Type: String
    Default: "NO"

  QAuditLog:
    Description: Select YES to create a CloudWatch Logs Group for the Qumulo Cluster that captures all Qumulo Audit Log Activity.
    AllowedValues:
      - "YES"
      - "NO"
    Type: String
    Default: "NO"

  SideCarPrivateSubnetID:
    Type: AWS::EC2::Subnet::Id
    Description: An AWS subnet ID MUST be selected. Select a subnet in one of the region's AZs (not in a Local Zone, not an Outpost Subnet). It is only used if YES for Local Zone or Outpost was selected above.

  SideCarProv:
    Description: "By default the Qumulo Sidecar Lambdas are deployed to monitor and replace failed EBS volumes plus send metrics to CloudWatch.  Leave this at default for production environments with WAF compliance.  
                  The ability to disable this provisioning is offerred just for test environments."
    AllowedValues:
      - "YES"
      - "NO"      
    Type: String
    Default: "YES"

  SideCarVersion:
    Description: "Software Version should match the desired cluster version at creation.  NOTE: This field may be used to upgrade the SideCar software version 
                  with a CloudFormation Stack Update after upgrading the cluster via the Web UI or REST API."
    MaxLength: 11
    MinLength: 5
    Type: String
    Default: "4.2.5"

  SideCarSNSTopic:
    Description: Optionally enter an SNS topic ARN that lambda errors and successful disk replacements will be published to.
    Type: String
    Default: ""

Conditions:

  UsingDefaultBucket: !Equals [!Ref QSS3BucketName, 'aws-quickstart']
  
  ProvR53: !Not
    - !Equals
      - !Ref DomainName
      - ""

  PubMgmt: !Not
    - !Equals
      - !Ref QPublicMgmt
      - "NO"

  LocalAZ: !Not
    - !Equals
      - !Ref QClusterLocalZone
      - "NO"

  ProvMgmt: !And [Condition: PubMgmt, !Not [Condition: LocalAZ]]

Rules:
  CustomRule:
    RuleCondition: !Equals [!Ref QMarketPlaceType, "Custom-1TB-6PB"]
    Assertions:
      - Assert: !Not [!Equals [!Ref QNodeCount, "Select for Custom Offering OR Expanding Cluster"]]
        AssertDescription: "A Custom Marketplace Offering requires the EC2 Instance Count to be selected. "
      - Assert: !Not [!Equals [!Ref QDiskConfig, "Select for Custom Offering"]]
        AssertDescription: "A Custom Marketplace Offering requires the EBS Volume Configuration to be selected. "

  SpecifiedAMIRule:
    RuleCondition: !Equals [!Ref QMarketPlaceType, "Specified-AMI-ID"]
    Assertions:
      - Assert: !Not [!Equals [!Ref QNodeCount, "Select for Custom Offering OR Expanding Cluster"]]
        AssertDescription: "A Specified AMI-ID Offering requires the EC2 Instance Count to be selected. "
      - Assert: !Not [!Equals [!Ref QDiskConfig, "Select for Custom Offering"]]
        AssertDescription: "A Specified AMI-ID Offering requires the EBS Volume Configuration to be selected. "
      - Assert: !Not [!Equals [!Ref QAmiID, "Only for Specified AMI-ID Offering"]]
        AssertDescription: "A Specified AMI-ID Offering requires an AMI-ID"

  LocalZoneEC2Rule:
    RuleCondition: !Equals [!Ref QClusterLocalZone, "YES"]
    Assertions:
      - Assert: !Not 
        - !Contains 
          - - c5n.4xlarge
            - c5n.9xlarge
            - c5n.18xlarge
          - !Ref QInstanceType
        AssertDescription: "Local Zones and Outposts do not support c5n EC2 instance types.  Use m5 instance types."
      - Assert: !Not [!Equals [!Ref PrivateSubnetID, !Ref SideCarPrivateSubnetID]]
        AssertDescription: "Deploy the Cluster in the Local Zone or Outpost subnet. Deploy the Sidecar Lambdas in a subnet associated with a Region AZ."
      - Assert: !Not [!Equals [ !Ref QPublicMgmt, "YES"]]
        AssertDescription: "Local Zones and Outpost do not support the Public Management Option."
      - Assert: !Not [!Equals [ !Ref QDr, "YES"]]
        AssertDescription: "Local Zones and Outpost do not support Qumulo Disaster Recovery Hybrid-sc1 clusters."       

  LocalZoneEBSMPRule:
    RuleCondition: !And [!Not [!Or [!Equals [!Ref QMarketPlaceType, "Custom-1TB-6PB"], !Equals [!Ref QMarketPlaceType, "Specified-AMI-ID"]]], !Equals [!Ref QClusterLocalZone, "YES"]]
    Assertions:
      - Assert: !Contains
        - - 1TB-Usable-All-Flash
          - 103TB-Usable-All-Flash
        - !Ref QMarketPlaceType
        AssertDescription: "Local Zones and Outposts do not support st1 EBS volume types.  Pick an All Flash configuration."

  LocalZoneEBSCustomRule:
    RuleCondition: !And [!Or [!Equals [!Ref QMarketPlaceType, "Custom-1TB-6PB"], !Equals [!Ref QMarketPlaceType, "Specified-AMI-ID"]], !Equals [!Ref QClusterLocalZone, "YES"]]
    Assertions:
      - Assert: !Contains
        - - 600GiB-AF
          - 1TB-AF
          - 5TB-AF
          - 8TiB-AF
          - 13TiB-AF
          - 20TiB-AF
          - 30TB-AF
          - 35TiB-AF
          - 55TiB-AF
        - !Ref QDiskConfig
        AssertDescription: "Local Zones and Outposts do not support st1 or sc1 EBS volume types.  Pick an All Flash configuration."

  SubnetsInVPCRule:
    Assertions:
      - Assert: !EachMemberIn
        - !ValueOfAll
          - "AWS::EC2::Subnet::Id"
          - VpcId
        - !RefAll "AWS::EC2::VPC::Id"
        AssertDescription: "All subnets must be in the same VPC"

  SubnetsInAZRule:
    RuleCondition: !And [!Equals [!Ref QClusterLocalZone, "NO"], !Equals [ !Ref QPublicMgmt, "YES"]]
    Assertions:
      - Assert: !Equals 
        - !ValueOf
          - PrivateSubnetID
          - AvailabilityZone
        - !ValueOf
          - PublicSubnetID
          - AvailabilityZone
        AssertDescription: "All subnets must be in the same Availability Zone when selecting the Public Management Option"

  EnvTypeRule:
    RuleCondition: !Not [!Equals [!Ref EnvType, "dev"]]
    Assertions: 
      - Assert: !Not [!Equals [!Ref QInstanceType, m5.xlarge]]
        AssertDescription: "m5.xlarge instance types are not supported for production environments.  Choose at least an m5.2xlarge or switch to a dev environment type."

  DrEBSRule:
    RuleCondition: !Equals [!Ref QDr, "YES"]
    Assertions:
      - Assert: !Contains
        - - Custom-1TB-6PB
          - Specified-AMI-ID
        - !Ref QMarketPlaceType
        AssertDescription: "Disaster Recovery Clusters require Custom-1TB-6PB or Specified-AMI-ID offering.  Select the appropriate offering."
      - Assert: !Contains 
        - - m5.xlarge
          - m5.2xlarge
          - m5.4xlarge
          - m5.8xlarge
        - !Ref QInstanceType
        AssertDescription: "Disastery Recovery Clusters support m5.2xlarge, m5.4xlarge, and m5.8xlarge instance types.  Select one of these EC2 instance types. "
      - Assert: !Contains 
        - - 8TiB-Hybrid-sc1
          - 13TiB-Hybrid-sc1
          - 20TB-Hybrid-sc1
          - 35TiB-Hybrid-sc1
          - 55TiB-Hybrid-sc1
          - 90TiB-Hybrid-sc1
          - 160TiB-Hybrid-sc1
          - 256TiB-Hybrid-sc1
          - 320TiB-Hybrid-sc1
        - !Ref QDiskConfig
        AssertDescription: "Disastery Recovery Clusters support Hybrid-sc1.  Select one of these EBS configurations."        

Resources:

  CloudQStack:
    Type: "AWS::CloudFormation::Stack"
    Properties:
      Parameters:
        QSS3BucketName: !Ref QSS3BucketName
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        QSS3BucketRegion: !Ref QSS3BucketRegion
        KeyPair: !Ref KeyPair
        EnvType: !Ref EnvType
        VPCId: !Ref VPCId
        QSgCidr1: !Ref QSgCidr1
        QSgCidr2: !Ref QSgCidr2        
        QSgCidr3: !Ref QSgCidr3   
        QSgCidr4: !Ref QSgCidr4          
        PrivateSubnetID: !Ref PrivateSubnetID
        QClusterLocalZone: !Ref QClusterLocalZone
        SideCarPrivateSubnetID: !Ref SideCarPrivateSubnetID
        QPublicMgmt: !Ref QPublicMgmt
        QPublicRepl: !Ref QPublicRepl
        PublicSubnetID: !Ref PublicSubnetID
        DomainName: !Ref DomainName
        QDr: !Ref QDr
        QFloatRecordName: !Ref QFloatRecordName
        QMarketPlaceType: !Ref QMarketPlaceType
        QAmiID: !Ref QAmiID
        QAmiVer: "4.2.0"        
        QInstanceType: !Ref QInstanceType
        QNodeCount: !Ref QNodeCount
        QDiskConfig: !Ref QDiskConfig
        QFloatingIP: !Ref QFloatingIP
        QClusterVersion: !Ref QClusterVersion
        QClusterName: !Ref QClusterName
        QClusterAdminPwd: !Ref QClusterAdminPwd
        VolumesEncryptionKey: !Ref VolumesEncryptionKey
        QPermissionsBoundary: !Ref QPermissionsBoundary        
        QInstanceRecoveryTopic: !Ref QInstanceRecoveryTopic
        QAuditLog: !Ref QAuditLog
        TermProtection: !Ref TermProtection
        SideCarProv: !Ref SideCarProv
        SideCarUsername: "SideCarUser"
        SideCarPassword: !Ref QClusterAdminPwd
        SideCarVersion: !Ref SideCarVersion
        SideCarSNSTopic: !Ref SideCarSNSTopic
      TemplateURL:
        !Sub
          - https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/cfn/cloudq.cft.yaml
          - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
            S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]

Outputs:

  QumuloPrivateIP:
    Description: Private IP for Qumulo Cluster Management
    Value: !GetAtt CloudQStack.Outputs.QumuloPrivateIP
  QumuloPublicIP:
    Condition: ProvMgmt
    Description: Public IP for Qumulo Cluster Management and Replication
    Value: !GetAtt CloudQStack.Outputs.QumuloPublicIP
  QumuloPrivateDNSName:
    Condition: ProvR53
    Description: Private DNS Name for Qumulo Cluster
    Value: !GetAtt CloudQStack.Outputs.QumuloPrivateDNSName
  QumuloKnowledgeBase:
    Description: Qumulo Knowledge Base
    Value: !GetAtt CloudQStack.Outputs.QumuloKnowledgeBase
    



